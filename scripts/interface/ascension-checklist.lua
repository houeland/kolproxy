-- TODO: add low/high values for how many you want instead of just a single number

consumable_items_high_impact = {
	-- { amount, item-list }
	{ 1, { "Knob Goblin perfume" } },

	{ 1, { "razor-sharp can lid" } },
	{ 1, { "spider web" } },
	{ 1, { "frigid ninja stars" } },
	{ 1, { "baseball" } },
	{ 1, { "barbed-wire fence" } },
	{ 1, { "sonar-in-a-biscuit" } },
	{ 1, { "NG" } },
	{ 1, { "disease" } },
	{ 1, { "photoprotoneutron torpedo" } },
	{ 1, { "chaos butterfly" } },
	{ 1, { "leftovers of indeterminate origin" } },
	{ 1, { "powdered organs" } },
	{ 1, { "plot hole" } },
	{ 1, { "inkwell" } },
	{ 1, { "stick of dynamite" } },
	{ 1, { "Knob Goblin firecracker" } },
	{ 1, { "mariachi G-string" } },
	{ 1, { "pygmy blowgun" } },
	{ 1, { "fancy bath salts" } },
	{ 1, { "tropical orchid" } },
	{ 1, { "black pepper" } },
	{ 1, { "bronzed locust" } },
	{ 1, { "meat vortex" } },

	{ 1, { "Boris's key lime pie" } },
	{ 1, { "Sneaky Pete's key lime pie" } },
	{ 1, { "Jarlsberg's key lime pie" } },
	{ 4, { "digital key lime pie" } },
	{ 4, { "star key lime pie" } },

	{ 3, { "milk of magnesium" } },
	{ 1, { "borrowed time" } },

	{ 1, { "star chart" } },

	{ 1, { "dusty bottle of Marsala" } },
	{ 1, { "dusty bottle of Merlot" } },
	{ 1, { "dusty bottle of Muscat" } },
	{ 1, { "dusty bottle of Pinot Noir" } },
	{ 1, { "dusty bottle of Port" } },
	{ 1, { "dusty bottle of Zinfandel" } },

	{ 1, { "ketchup hound" } },
	{ 1, { "stunt nuts" } },
	{ 1, { "drum machine" } },
	{ 1, { "wet stew" } },

	{ 1, { "furry fur" } },
	{ 1, { "awful poetry journal" } },
	{ 1, { "giant needle" } },

	{ 10, { "large box" } },
	{ 2, { "effervescent potion" } },
	{ 2, { "dark potion" } },
	{ 2, { "cloudy potion" } },
	{ 2, { "smoky potion" } },
	{ 2, { "milky potion" } },
	{ 2, { "murky potion" } },
	{ 2, { "swirly potion" } },
	{ 2, { "bubbly potion" } },
	{ 2, { "fizzy potion" } },

	{ 1, { "marzipan skull" } },
	{ 1, { "jaba&ntilde;ero-flavored chewing gum" } },
	{ 1, { "handsomeness potion" } },
	{ 1, { "Meleegra&trade; pills" } },
	{ 1, { "pickle-flavored chewing gum" } },
	{ 1, { "tamarind-flavored chewing gum" } },
	{ 1, { "lime-and-chile-flavored chewing gum" } },

	{ 1, { "gremlin juice" } },
	{ 1, { "wussiness potion" } },
	{ 1, { "Mick's IcyVapoHotness Rub" } },
	{ 1, { "pygmy pygment" } },
	{ 1, { "super-spiky hair gel" } },
	{ 1, { "adder bladder" } },
	{ 1, { "Black No. 2" } },

	{ 3, { "hot wing" } },
}

consumable_items_normal_impact = {
	-- { amount, item-list }
	{ 9, { "Breathetastic&trade; Premium Canned Air", "Instant Karma" } },

	{ 1, { "phial of hotness" } },
	{ 1, { "phial of coldness" } },
	{ 1, { "phial of stench" } },
	{ 1, { "phial of spookiness" } },
	{ 1, { "phial of sleaziness" } },

	{ 3, { "stone wool" } },
	{ 2, { "divine champagne popper" } },
	{ 2, { "crystal skull" } },

	{ 3, { "fudge bunny" } },
	{ 10, { "Moon Pie" } },
	{ 10, { "Wrecked Generator" } },
	{ 5, { "Frosty's frosty mug" } },
	{ 5, { "Ol' Scratch's salad fork" } },
	{ 5, { "huge pumpkin" } },
	{ 2, { "bucket of wine" } },

	{ 4, { "fancy chocolate car" } },
	{ 4, { "vitachoconutriment capsule" } },
	{ 5, { "tiny bottle of absinthe" } },
	{ 15, { "glimmering roc feather", "not-a-pipe" } },
	{ 3, { "glimmering raven feather" } },
	{ 5, { "prismatic wad" } },

	{ 1, { "glass of goat's milk" } },
	{ 2, { "spice melange" } },
	{ 1, { "tempura cauliflower" } },
	{ 2, { "distention pill" } },
	{ 2, { "synthetic dog hair pill" } },
	{ 5, { "mojo filter" } },

	{ 3, { "peppermint crook" } },

	{ 10, { "Knob Goblin lunchbox" } },
	{ 5, { "tofu chow mein" } },
	{ 10, { "Mon Tiki", "teqiwila slammer" } },
	{ 10, { "gimlet", "yellow brick road" } },
	{ 10, { "Mae West", "prussian cathouse" } },
	{ 2, { "bunch of square grapes" } },
	{ 2, { "bowl of rye sprouts" } },
	{ 2, { "cob of corn" } },
	{ 2, { "brown sugar cane" } },
	{ 2, { "cactus fruit" } },
	{ 2, { "juniper berries" } },
	{ 2, { "corpsedriver" } },
	{ 2, { "corpsetini" } },
	{ 2, { "corpse on the beach" } },

	{ 2, { "jar of fermented pickle juice" } },
	{ 2, { "jar of squeeze" } },
	{ 2, { "extra-greasy slider" } },
	{ 5, { "slimy alveolus" } },

	{ 10, { "star" } },
	{ 10, { "line" } },

	{ 2, { "Boris's ring" } },
	{ 2, { "Jarlsberg's earring" } },
	{ 2, { "Sneaky Pete's breath spray" } },

	{ 2, { "peppermint parasol" } },
	{ 5, { "unbearable light" } },

	{ 11, { "tomb ratchet" } },
	{ 6, { "goat cheese" } },
	{ 3, { "668 scroll" } },
	{ 3, { "64067 scroll" } },
	{ 3, { "30669 scroll" } },

	{ 1, { "enchanted bean" } },

	{ 2, { "NPZR chemistry set" } },

	{ 2, { "cyclops eyedrops" } },
	{ 2, { "Mick's IcyVapoHotness Inhaler" } },
	{ 2, { "sorority brain" } },
	{ 2, { "handful of pine needles" } },
	{ 2, { "chunk of rock salt" } },
	{ 3, { "thin black candle" } },
	{ 1, { "scroll of ancient forbidden unspeakable evil" } },

	{ 10, { "disassembled clover" } },

	{ 1, { "dingy planks" } },
	{ 1, { "clockwork maid" } },
	{ 1, { "clockwork pirate skull" } },
	{ 2, { "clockwork bartender-in-the-box" } },
	{ 2, { "clockwork chef-in-the-box" } },
	{ 1, { "chef-in-the-box" } },
	{ 2, { "bartender-in-the-box" } },
	{ 1, { "box-in-the-box-in-the-box" } },

	{ 1, { "dope wheels" } },

	{ 10, { "soft green echo eyedrop antidote" } },

	{ 10, { "gauze garter" } },
	{ 10, { "filthy poultice" } },
	{ 5, { "skeleton key" } },
	{ 1, { "Spooky-Gro fertilizer" } },

	{ 5, { "wang" } },

	{ 3, { "facsimile dictionary" } },

	{ 3, { "asbestos ore" } },
	{ 3, { "linoleum ore" } },
	{ 2, { "heavy metal sonata" } },
	{ 1, { "heavy metal thunderrr guitarrr" } },

	{ 3, { "blue shell" } },

	{ 1, { "antique 8-Bit Power magazine" } },

	{ 10, { "bottle of Blank-Out" } },
}

consumable_items_low_impact = {
	{ 9, { "bottle of single-barrel whiskey" } },
	{ 1, { "soy cordial" } },
	{ 2, { "baobab sap" } },
	{ 2, { "Marvin's marvelous pill" } },
	{ 2, { "desktop zen garden" } },
	{ 3, { "cranberry schnapps" } },
	{ 5, { "oily mushroom wine" } },
	{ 2, { "Pan-Dimensional Gargle Blaster" } },
	{ 2, { "sandwich of the gods" } },
	{ 5, { "pebblebr&auml;u" } },
	{ 3, { "floaty inverse geode" } },
	{ 3, { "pixel orb" } },
	{ 3, { "gummi ammonite" } },
	{ 3, { "gummi belemnite" } },
	{ 3, { "gummi trilobite" } },
	{ 2, { "bunch of bananas" } },
	{ 3, { "Uncle Crimbo's Rations" } },
}

equipment_items = {
	-- { affordable?, item-list }
	{ true, { "vinyl shield" } },
	{ true, { "Wand of Nagamar" } },
	{ true, { "pool cue" } },

	{ true, { "bone rattle" } },

	{ true, { "Rock and Roll Legend" } },
	{ true, { "Mace of the Tortoise" } },
	{ true, { "5-Alarm Saucepan" } },

	{ true, { "monster bait" } },
	{ true, { "ring of conflict" } },
	{ true, { "star crossbow", "star staff", "star sword" } },
	{ true, { "star hat" } },

	{ true, { "frilly skirt" } },
	{ true, { "mullet wig" } },
	{ true, { "briefcase" } },

	{ true, { "Orcish baseball cap" } },
	{ true, { "Orcish cargo shorts" } },
	{ true, { "homoerotic frat-paddle" } },

	{ true, { "filthy corduroys" } },
	{ true, { "filthy knitted dread sack" } },

	{ true, { "swashbuckling pants" } },
	{ true, { "stuffed shoulder parrot" } },
	{ true, { "eyepatch" } },

	{ true, { "Knob Goblin harem veil" } },
	{ true, { "Knob Goblin harem pants" } },

	{ true, { "Knob Goblin elite polearm" } },
	{ true, { "Knob Goblin elite pants" } },
	{ true, { "Knob Goblin elite helm" } },

	{ true, { "beer helmet" } },
	{ true, { "distressed denim pants" } },
	{ true, { "bejeweled pledge pin" } },

	{ true, { "reinforced beaded headband" } },
	{ true, { "bullet-proof corduroys" } },
	{ true, { "round purple sunglasses" } },
	{ true, { "cane-mail shirt" } },

	{ false, { "Mint-in-box Moonthril Cuirass", "Grimacite gown" } },
	{ false, { "hockey stick of furious angry rage" } },

	{ false, { "aquaviolet jub-jub bird", "charpuce jub-jub bird", "crimsilion jub-jub bird" } },
	{ false, { "spangly mariachi pants" } },
	{ false, { "quake of arrows" } },

	{ false, { "Spooky Putty leotard", "Spooky Putty mitre", "Spooky Putty sheet", "Spooky Putty snake" } },
	{ false, { "moveable feast" } },
	{ false, { "jewel-eyed wizard hat" } },
	{ false, { "stinky cheese ball", "stinky cheese sword", "stinky cheese diaper", "stinky cheese wheel", "stinky cheese eye", "Staff of Queso Escusado" } },
	{ false, { "Bag o' Tricks" } },
	{ false, { "haiku katana" } },
	{ false, { "ice sickle" } },
	{ false, { "Clan VIP Lounge key" } },
	{ false, { "little box of fireworks" } },
	{ false, { "Operation Patriot Shield", "pilgrim shield" } },
	{ false, { "flaming pink shirt", "liar's pants" } },
	{ false, { "Crown of Thrones" } },
	{ false, { "Juju Mojo Mask", "V for Vivala mask" } },
	{ false, { "Greatest American Pants", "navel ring of navel gazing" } },
	{ false, { "Loathing Legion knife", "Loathing Legion necktie", "Loathing Legion moondial", "Loathing Legion helicopter", "Loathing Legion universal screwdriver", "Loathing Legion jackhammer" } },
	{ false, { "plastic vampire fangs" } },
	{ false, { "Camp Scout backpack" } },

	{ false, { "BRICKO airship" } },
	{ false, { "ninja pirate zombie robot head" } },
}

local function extract_itemdata(itd)
	local rel = itd:match([[rel=".-"]])
	local id = tonumber(rel:match("id=([0-9]+)"))
	local n = tonumber(rel:match("n=([0-9]+)"))
	local ircmtext = itd:match([[<b class="ircm">(.-)</b>]])
	local name = ircmtext:match([[<a.->(.-)</a>]]) or ircmtext
	return name, id, n
end

function ascension_checklist_get_questitem_text()
	if not freedralph() then return "" end
	ordered_items = {}
	local quest_items = {}
	table.insert(quest_items, { name = "map to Vanya's Castle", link = "Remember to kill Vanya's Creature [map to Vanya's Castle]" })
	for x in table.values { "Boris's key", "Jarlsberg's key", "Sneaky Pete's key", "digital key", "Richard's star key" } do
		table.insert(quest_items, { name = x, link = [[<a href="#" onclick="cook_key(this, ]]..get_itemid(x)..[[); return false;" style="color: green;">Cook ]] .. x })
	end
	for x in table.values { "Map to Safety Shelter Grimace Prime", "Dolphin King's map", "Dr. Hobo's map" } do
		table.insert(quest_items, { name = x, link = "Use " .. x })
	end
	for x in table.values(quest_items) do
		if have(x.name) then
			table.insert(ordered_items, [[<tr><td>]] .. x.link .. [[</td></tr>]])
		end
	end
	if not next(ordered_items) then
		return ""
	else
		return [[
<h2>Unhandled quest items</h2>
<table style="border: 1px solid black; padding: 5px; margin: 5px">
<tr><th>Item</th></tr>
<tbody>]] .. table.concat(ordered_items) .. [[
</tbody>
</table>
]]
	end
end

local cook_key_href = add_automation_script("custom-ascension-checklist-cook-key-lime", function()
	local whichitem = tonumber(params.whichitem)
	if whichitem and have_inventory_item(whichitem) then
		if not have_item("lime") then
			pull_storage_items { "lime" }
		end
		return cook_items(whichitem, "lime")()
	else
		critical "Invalid item."
	end
end)

local href = add_automation_script("custom-ascension-checklist", function()
	local inventory = {}
	local storage = {}
	local closet = {}
	local page_functions = {}
	do
		page_functions.storage = {}
		page_functions.closet = {}
		page_functions.fillcloset = {}
		for which in table.values { 1, 2, 3 } do
			page_functions.storage[which] = async_get_page("/storage.php", { which = which })
			page_functions.closet[which] = async_get_page("/closet.php", { which = which })
			page_functions.fillcloset[which] = async_get_page("/fillcloset.php", { which = which })
		end
	end
	do
		for which in table.values { 1, 2, 3 } do
			local pt = page_functions.storage[which]()
			for itd in pt:gmatch([[<td class="i"[^>]*><table class='item'.-</table></td>]]) do
				local name, id, n = extract_itemdata(itd)
				storage[name] = n
			end
		end

		for which in table.values { 1, 2, 3 } do
			local pt = page_functions.closet[which]()
			for itd in pt:gmatch([[<td class="i"[^>]*><table class='item'.-</table></td>]]) do
				local name, id, n = extract_itemdata(itd)
				closet[name] = n
			end
		end

		for which in table.values { 1, 2, 3 } do
			local pt = page_functions.fillcloset[which]()
			for itd in pt:gmatch([[<td class="i"[^>]*><table class='item'.-</table></td>]]) do
				local name, id, n = extract_itemdata(itd)
				inventory[name] = n
			end
		end
	end

	sorted_need_text = ""
	sorted_have_text = ""
	do
		sorted_mapped = {}
		function classify(have, want, importance)
			if have < want and importance > 0 then
				return -10, [[ style="background-color: red;"]]
			elseif have < want and importance >= 0 then
				return -5, [[ style="background-color: darkorange;"]]
			elseif have < want then
				return -3, ""
			elseif have < want * 2 + 2 then
				return -2, [[ style="color: gray;"]]
			else
				return 1, [[ style="color: gray;"]]
			end
		end
		local function handle_consumable(x, importance)
			want, names = x[1], x[2]
			i = 0
			c = 0
			s = 0
			for _, n in ipairs(names) do
				get_itemid(n) -- spellcheck for valid name
				i = i + (inventory[n] or 0)
				c = c + (closet[n] or 0)
				s = s + (storage[n] or 0)
			end
			total = i + c + s
			sortclass, style = classify(total, want, importance)
			local extrainfo = ""
			if importance > 0 then
				extrainfo = [[ <span style="font-size: smaller; color: gray;">(cheap and important pull!)</span>]]
			elseif importance < 0 then
				extrainfo = [[ <span style="font-size: smaller; color: gray;">(expensive and uncommon pull)</span>]]
			end
			table.insert(sorted_mapped, { sortclass = sortclass, style = style, items = table.concat(names, "<br>\n") .. extrainfo, total = total, inventory = i, closet = c, storage = s, want = want, importance = importance })
		end
		for _, x in ipairs(consumable_items_high_impact) do
			handle_consumable(x, 100)
		end
		for _, x in ipairs(consumable_items_normal_impact) do
			handle_consumable(x, 0)
		end
		for _, x in ipairs(consumable_items_low_impact) do
			handle_consumable(x, -100)
		end
		table.sort(sorted_mapped, function(a, b)
			if a.importance ~= b.importance then return a.importance > b.importance end
			if a.sortclass ~= b.sortclass then return a.sortclass < b.sortclass end
			if a.total ~= b.total then return a.total < b.total end
			return a.items < b.items
		end)
		for _, x in ipairs(sorted_mapped) do
			cells = { x.items, x.total .. " / " .. x.want, x.inventory, x.closet, x.storage }
			cell_text = ""
			for i = 1, 5 do
				if i <= 2 then
					cell_text = cell_text .. "<td>" .. cells[i] .. "</td>"
				else
					cell_text = cell_text .. [[<td class="extralocation">]] .. cells[i] .. "</td>"
				end
			end
			if x.sortclass < 0 then
				sorted_need_text = sorted_need_text .. "<tr" .. x.style .. ">" .. cell_text .. "</tr>\n"
			else
				sorted_have_text = sorted_have_text .. "<tr" .. x.style .. ">" .. cell_text .. "</tr>\n"
			end
		end
	end
	consumable_text = [[
<table style="border: 1px solid black; padding: 5px; margin: 5px">
<tr><th>Item</th><th>Total</th><th class="extralocation">Inventory</th><th class="extralocation">Closet</th><th class="extralocation">Storage</th></tr>
<tbody>]] .. (sorted_need_text) .. [[
</tbody>
<tbody id="extraitems" style="display: none;">]] .. (sorted_have_text) .. [[
</tbody></table>
]]

	equipment_text = ""
	do
		sorted_mapped = {}
		function stocked(name)
			return inventory[name] or closet[name] or storage[name] or have_equipped(name)
		end
		for _, x in ipairs(equipment_items) do
			cheap, names = x[1], x[2]
			local ok = false
			for _, n in ipairs(names) do
				if stocked(n) then
					ok = true
				end
			end
			if not ok then
				if cheap then
					table.insert(sorted_mapped, { sortclass = -10, tr = [[<tr style="background-color: red"><td>]] .. table.concat(names, ", ") .. [[</td></tr>]] })
				else
					table.insert(sorted_mapped, { sortclass = 1, tr = [[<tr><td>]] .. table.concat(names, ", ") .. [[</td></tr>]] })
				end
			end
		end
		if table.maxn(sorted_mapped) > 0 then
			table.sort(sorted_mapped, function(a, b)
				if a.sortclass ~= b.sortclass then return a.sortclass < b.sortclass end
				return a.tr < b.tr
			end)
			for _, x in ipairs(sorted_mapped) do
				equipment_text = equipment_text .. x.tr
			end
			equipment_text = [[<table style="border: 1px solid black; padding: 5px; margin: 5px">]] .. equipment_text .. [[</table>]]
		else
			equipment_text = [[<p>Nothing missing.</p>]]
		end
	end

	pt = [[
<!DOCTYPE html>
<html>
<head>
<title>kolproxy ascension checklist</title>
<link rel="stylesheet" type="text/css" href="http://images.kingdomofloathing.com/styles.css">
<style type="text/css">
td {
	padding: 2px 5px;
}
.extralocation { display: none }
</style>
<script type="text/javascript" src="http://images.kingdomofloathing.com/scripts/jquery-1.3.1.min.js"></script>
<script type="text/javascript">
	function cook_key_result(link, pagetext) {
		if (pagetext.match(/You acquire/)) {
			link.style.color = 'gray';
		} else {
			link.style.color = 'red';
		}
	}
	function cook_key(link, itemid) {
		]] .. cook_key_href { pwd = session.pwd, __raw__whichitem = "itemid", make_jquery = "type: 'POST', success: function(retdata) { cook_key_result(link, retdata) }" } .. [[

	}
</script></head>
<body>
]] .. ascension_checklist_get_questitem_text() .. [[
<h2>Consumable items</h2>
]] .. consumable_text .. [[
<script type="text/javascript">
function show_extraitems() {
	$("#extraitems").show()
	$("#show_extraitems_link").hide()
}
function show_item_locations() {
	$(".extralocation").show()
	$("#show_item_locations_link").hide()
}
</script>
<span id="show_extraitems_link">(<a href="javascript:show_extraitems()">Show well-stocked items</a>)<br></span>
<span id="show_item_locations_link">(<a href="javascript:show_item_locations()">Show item locations</a>)<br></span>
(<a href="ascend.php">Back to ascending</a>)

<h2>Equipment and other non-consumables</h2>
]] .. equipment_text .. [[(<a href="ascend.php">Back to ascending</a>)
</body></html>]]
	return pt, requestpath
end)

add_printer("/ascend.php", function()
	text = text:gsub("Are you ready to take the plunge%?", [[%0 <a href="]] .. href { pwd = session.pwd } .. [[" style="color:green">{ Storage stocking checklist }</a>]])
end)
