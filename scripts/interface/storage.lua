aftercore_items_list = {
	"V for Vivala mask",
	"Juju Mojo Mask",
	"mayfly bait necklace",
	"moveable feast",
	"pilgrim shield",
	"Greatest American Pants",
	"jewel-eyed wizard hat",
	"navel ring of navel gazing",
	"Jekyllin hide belt",
	"little box of fireworks",
	"haiku katana",
	"Bag o' Tricks",
	"Elvish sunglasses",
	"tiny costume wardrobe",
	"flaming pink shirt",
	"liar's pants",
	"Spooky Putty mitre",
	"Spooky Putty sheet",
	"Spooky Putty snake",
	"Spooky Putty leotard",
	"Staff of Queso Escusado",
	"stinky cheese diaper",
	"stinky cheese eye",
	"ice sickle",
	"Crown of Thrones",
	"right bear arm",
	"left bear arm",
	"Snow Suit",
	"Boris's Helm",
	"Boris's Helm (askew)",
	"Jarlsberg's pan",
	"Jarlsberg's pan (Cosmic portal mode)",
	"over-the-shoulder Folder Holder",
	"Pantsgiving",
	"Buddy Bjorn",
	"Sneaky Pete's leather jacket",
	"Sneaky Pete's leather jacket (collar popped)",

	"plexiglass pants",
	"plexiglass pendant",
	"plexiglass pikestaff",
	"plexiglass pinky ring",
	"plexiglass pith helmet",
	"plexiglass pocketwatch",
	"Brimstone Beret",
	"Brimstone Bludgeon",
	"Brimstone Boxers",
	"Brimstone Bracelet",
	"Brimstone Brooch",
	"Brimstone Bunker",
	"stainless steel scarf",
	"stainless steel shillelagh",
	"stainless steel skullcap",
	"stainless steel slacks",
	"stainless steel solitaire",
	"stainless steel suspenders",

	"aerated diving helmet",
	"fishy pipe",

	"bounty-hunting helmet",
	"bounty-hunting rifle",
	"bounty-hunting pants",
	"Order of the Silver Wossname",
	"Staff of the Woodfire",
	"Staff of the Walk-In Freezer",
	"Oscus's neverending soda",
	"Mr. Accessory Jr.",

	"corrosive cowl",
	"villainous scythe",
	"corroded breeches",
	"baneful bandolier",
	"malevolent medallion",
	"grisly shield",
	"pernicious cudgel",
	"diabolical crossbow",

	"Hodgman's bow tie",
	"Hodgman's porkpie hat",
	"Hodgman's lobsterskin pants",
	"Hodgman's lucky sock",
	"Hodgman's metal detector",
	"Hodgman's garbage sticker",
	"Hodgman's whackin' stick",
	"Hodgman's disgusting technicolor overcoat",
	"Hodgman's imaginary hamster",

	"sushi-rolling mat",
	"The Legendary Beat",
	"Chester's bag of candy",
	"Clan VIP Lounge key",
	"hobo code binder",
	"LARP membership card",
	"crumpled felt fedora",
	"hardened slime belt",
	"hobo dungarees",
	"Mr. Accessory",
	"old patched suit-pants",
	"old-school flying disc",
	"Staff of the Deepest Freeze",
	"das boot",
	"hobo nickel",

	"plain brown wrapper",
	"less-than-three-shaped box",
	"exactly-three-shaped box",
	"chocolate box",
	"miniature coffin",
	"solid asbestos box",
	"solid linoleum box",
	"solid chrome box",
	"cryptic puzzle box",
	"refrigerated biohazard container",
	"magnetic field",
	"black velvet box",

	"anniversary gift box",
	"moist sack",
	"bindle of joy",
	"foreign box",
	"raffle prize box",
	"Warehouse 23 crate",

	"Space Trip safety headphones",

	"time helmet",
	"time sword",
	"time trousers",
	"glow-in-the-dark wristwatch",

	"depleted Grimacite astrolabe",
	"depleted Grimacite grappling hook",
	"depleted Grimacite gravy boat",
	"depleted Grimacite ninja mask",
	"depleted Grimacite shinguards",
	"depleted Grimacite weightlifting belt",

	"ball-in-a-cup",
	"handmade hobby horse",
	"set of jacks",

	"disassembled clover",

	"scented massage oil",

	"bone spurs",

	"natty blue ascot",
	"C.A.R.N.I.V.O.R.E. button",

	"Miniborg Destroy-O-Bot",

	"Uncle Hobo's epic beard",

	"ittah bittah hookah",

	"Operation Patriot Shield",
	"plastic vampire fangs",
	"Camp Scout backpack",

	"Loathing Legion knife",
	"Loathing Legion moondial",
	"Loathing Legion necktie",

	"pixel morning star",

	"BRICKO airship",
	"leather aviator's cap",
	"burrowgrub hive",
	"cheap toaster",
	"paperclip pants",
	"BGE pocket calendar",

	"Uncle Hobo's fingerless tinsel gloves",
	"Zombo's skull ring",

	"insulting hat",
	"offensive moustache",

	"can of Rain-Doh",

	"Trivial Avocations board game",
	"Jackass Plumber home game",

	"KoL Con Six Pack",

	"Goggles of Loathing",
	"Stick-Knife of Loathing",
	"Scepter of Loathing",
	"Jeans of Loathing",
	"Treads of Loathing",
	"Belt of Loathing",
	"Pocket Square of Loathing",

	"Lens of Hatred",
	"Staff of Simmering Hatred",
	"Cold Stone of Hatred",
	"Pantaloons of Hatred",
	"Fuzzy Slippers of Hatred",
	"Girdle of Hatred",

	"Lens of Violence",
	"Pigsticker of Violence",
	"Brand of Violence",
	"Jodhpurs of Violence",
	"Ass-Stompers of Violence",
	"Novelty Belt Buckle of Violence",

	"Chroner trigger",
	"Chroner cross",
}

maybe_pvp_stealable = {
	"shark jumper",
	"square sponge pants",
	"sea salt scrubs",
	"General Sage's Lonely Diamonds Club Jacket",
	"hipposkin poncho",
	"Mer-kin sneakmask",
	"glowing esca",
	"diving muff",
	"teflon swim fins",
	"nurse's hat",
	"vinyl shield",
	"battered hubcap",
	"Rock and Roll Legend",
	"Mace of the Tortoise",
	"5-Alarm Saucepan",
	"ring of conflict",
	"duonoculars",
	"monster bait",
	"rice bowl",
	"tiny plastic skeletal reindeer",
	"tuxedo shirt",
	"sword behind inappropriate prepositions",
	"velcro boots",
	"chamoisole",
	"anti-anti-antidote",
	"glass gnoll eye",
	"psycho sweater",
	"Ankh of Badahnkadh",
	"blackberry slippers",
	"eelskin hat",
	"divine noisemaker",
	"beefy fish meat",
	"eel sauce",
	"glistening fish meat",
	"sand dollar",
	"seaweed",
	"skate board",
	"slick fish meat",
	"white rice",
	"grog",
	"lime",
	"rockin' wagon",
	"beer basted brat",
	"super salad",
	"white Canadian",
	"cup of primitive beer",
	"milk of magnesium",
	"not-a-pipe",
	"prismatic wad",
	"twinkly wad",
	"agua de vida",
	"shot of blackberry schnapps",
	"spooky lo mein",
	"olive lo mein",
	"pear tart",
	"mojo filter",
	"oil of slipperiness",
	"philter of phorce",
	"soft green echo eyedrop antidote",
	"tomato juice of powerful power",
	"spices",
	"seal tooth",
	"ancient Magi-Wipes",
	"Corporal Fennel's Lonely Clubs Club Jacket",
	"hamethyst necklace",
	"filigreed hamethyst necklace",

	"spangly sombrero",
	"spangly mariachi pants",
}

function repeat_send_form(targeturl, action, howmany, pwd, itemids)
	local function send_form(p)
		local tbl = { pwd = pwd, action = action, ajax = "1" }
		for a, b in pairs(p) do
			tbl["howmany" .. a] = howmany
			tbl["whichitem" .. a] = tostring(b)
		end
		async_post_page(targeturl, tbl)
	end

	local this_form = {}
	for _, n in ipairs(itemids) do
		table.insert(this_form, n)
		if #this_form >= 11 then
			send_form(this_form)
			this_form = {}
		end
	end
	if #this_form > 0 then
		send_form(this_form)
		this_form = {}
	end
end

local function get_safe_interesting_items()
	local tbl = {}
	for _, x in ipairs(aftercore_items_list) do
		tbl[x] = not can_pvp_steal_item(x)
	end
	for _, x in ipairs(maybe_pvp_stealable) do
		tbl[x] = not can_pvp_steal_item(x)
	end
	for _, x in ipairs(daily_visits_use_items) do
		tbl[x] = not can_pvp_steal_item(x)
	end
	local ret = {}
	for x, y in pairs(tbl) do
		if y then
			table.insert(ret, x)
		end
	end
	return ret
end

local closet_href = add_automation_script("automate-closet", function()
	local keep_items = {}
	for _, x in ipairs(get_safe_interesting_items()) do
		keep_items[get_itemid(x)] = true
	end
	for x, y in pairs(inventory()) do
		if not keep_items[x] then
			async_post_page("/fillcloset.php", { action = "closetpush", whichitem = x, qty = y, pwd = params.pwd, ajax = 1 })
		end
	end

	return get_page("/closet.php")
end)

add_printer("/closet.php", function()
	local pwd = text:match[[name="pwd" *value="(%x-)"]]
	if pwd then
		text = text:gsub([[%[Fill Your Closet%]</a>]], [[%0 <a href="]].. closet_href { pwd = pwd } ..[[" style="color: green">{ Closet some items }</a>]])
	end
end)

function automate_aftercore_pulls()
	local _, items, _ = retrieve_all_item_locations()

	local itemids = {}
	for _, x in ipairs(get_safe_interesting_items()) do
		if items[x] then
			table.insert(itemids, get_itemid(x))
		end
	end

	repeat_send_form("/storage.php", "pull", "1", params.pwd, itemids)

	return get_page("/storage.php", { which = 5 })
end

local pull_href = add_automation_script("automate-aftercore-pulls", automate_aftercore_pulls)

add_printer("/storage.php", function()
	local pwd = text:match[[name=pwd value='(%x-)']]
	if pwd then
		text = text:gsub([[<input type=submit class=button value="Take all your stuff out of Hagnk's">]], [[<center><a href="]].. pull_href { pwd = pwd } ..[[" style="color: green">{ Pull some items }</a></center><p>%0]])
	end
end)

function retrieve_storage_items()
	local storage = {}
	local json = get_page("/api.php", { what = "storage", ["for"] = "Kolproxy by Eleron (from Lua script)", format = "json" })
	for x, y in pairs(json_to_table(json)) do
		storage[tonumber(x)] = y
	end
	return storage
end

local cached_storage_items = nil
local cached_storage_state_id = nil
function get_cached_storage_items()
	if cached_storage_state_id ~= state_identifier() then
		cached_storage_items = nil
		cached_storage_state_id = state_identifier()
	end
	if not cached_storage_items then
		cached_storage_items = retrieve_storage_items()
	end
	return cached_storage_items
end

function could_have_item_in_storage(item)
	return get_cached_storage_items()[get_itemid(item)]
end
